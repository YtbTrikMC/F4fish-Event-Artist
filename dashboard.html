<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trang ch·ªß - Artists</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .level-container { width: 100%; background: #ddd; border-radius: 10px; margin: 10px 0; position: relative; height: 22px; overflow: hidden; }
        .level-bar { height: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); width: 0%; transition: 0.5s; }
        .level-text { position: absolute; width: 100%; text-align: center; font-size: 12px; line-height: 22px; font-weight: bold; color: #000; z-index: 1; }
        
        /* Style cho Bao Qu√† May M·∫Øn */
        .lucky-box-section { 
            margin-top: 20px; 
            padding: 15px; 
            background: linear-gradient(145deg, #ff4757, #e84118); 
            border: 3px solid #fbc531; 
            border-radius: 15px; 
            color: white; 
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .lucky-btn { 
            background: #fbc531; 
            color: #c23616; 
            font-weight: bold; 
            border: none; 
            padding: 12px 30px; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: 16px;
            text-transform: uppercase;
            box-shadow: 0 4px 0 #e1b12c;
            transition: 0.2s;
        }
        .lucky-btn:active { transform: translateY(4px); box-shadow: none; }
        .lucky-btn:disabled { background: #95a5a6; color: #7f8c8d; box-shadow: none; cursor: not-allowed; }
    </style>
</head>
<body>
    <marquee id="marqueeTxt" class="marquee-style">ƒêang t·∫£i...</marquee>
    
    <div class="header-bar">
        <div class="balance">Xu: <span id="userCoins">0</span> ü™ô | Level: <span id="userLevel">1</span></div>
        <button class="gift-btn" onclick="useGiftcode()">GIFTCODE</button>
    </div>

    <div class="main-content">
        <div class="level-container">
            <div class="level-text" id="levelScoreTxt">0/100 XP</div>
            <div class="level-bar" id="levelBar"></div>
        </div>

        <div class="fish-section">
            <img src="" id="fishGif" class="fish-gif" onclick="feedFish()" alt="C√°">
            <button id="btnFeed" class="feed-btn" onclick="feedFish()">CHO C√Å ƒÇN (MI·ªÑN PH√ç 24H)</button>
        </div>

        <div class="lucky-box-section">
            <h2 style="margin: 0 0 5px 0;">üßß BAO QU√Ä MAY M·∫ÆN</h2>
            <p style="font-size: 13px; margin-bottom: 10px;">Qu·ªπ qu√† t·∫∑ng c√≤n: <span id="poolCoins" style="font-weight: bold; color: #fbc531;">0</span> Xu</p>
            <button id="btnLixi" class="lucky-btn" onclick="openLuckyBox()">M·ªû QU√Ä NGAY</button>
            <p id="lixiStatus" style="font-size: 11px; margin-top: 10px; opacity: 0.9;"></p>
        </div>

        <div class="shop-section" style="margin-top:15px; border:1px dashed #3498db; padding:10px;">
            <p style="font-size:12px;">C·ª≠a h√†ng: 10 xu = +10 XP (Kh√¥ng k√®m xu th∆∞·ªüng)</p>
            <button onclick="buyFood()" style="background:orange; padding:5px 15px; color:white; border-radius:5px;">MUA TH·ª®C ƒÇN</button>
        </div>

        <div id="adminInfo" class="info-box" style="margin-top:15px;"></div>
        <h3>üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
        <ul id="leaderboardList"></ul>
    </div>

    <script>
        const p1 = "h" + "tt" + "ps://";
        const p2 = "api" + "." + "steinhq" + ".com";
        const p3 = "/v1/storages/";
        const p4 = "699" + "eda16" + "affba40a" + "6254160c"; 
        const FULL_URL = p1 + p2 + p3 + p4 + "/Sheet1";

        let userData = JSON.parse(localStorage.getItem("currentUser"));
        const GIFS = {
            lv1: "https://image2url.com/r2/default/gifs/1772020990089-c0dba8da-4cd7-4f28-b2e8-8fc7eb632f26.gif",
            lv2: "https://image2url.com/r2/default/gifs/1772021046327-83a1abb8-5bc1-47a7-888e-34918c5a1410.gif",
            lv3: "https://image2url.com/r2/default/gifs/1772021071582-773603d9-15ed-4bb0-a37f-6d801ccd3639.gif"
        };

        async function init() {
            if (!userData) { window.location.href = "index.html"; return; }
            try {
                const res = await fetch(FULL_URL);
                const allData = await res.json();
                const freshData = allData.find(u => u.username === userData.username);
                if(freshData) { userData = freshData; localStorage.setItem("currentUser", JSON.stringify(freshData)); }

                const config = allData[0];
                const score = parseInt(userData.level_score) || 0;
                const level = Math.floor(score / 100) + 1;
                const xpInLevel = score % 100;

                // Update UI
                document.getElementById('userLevel').innerText = level;
                document.getElementById('userCoins').innerText = userData.coins;
                document.getElementById('levelBar').style.width = xpInLevel + "%";
                document.getElementById('levelScoreTxt').innerText = xpInLevel + "/100 XP";
                document.getElementById('marqueeTxt').innerText = "TH√îNG B√ÅO: " + (config.marquee_text || "");
                document.getElementById('adminInfo').innerText = config.info_box || "";
                window.allGiftcodes = config.giftcode_val || "";
                document.getElementById('poolCoins').innerText = config.coins;

                const img = document.getElementById('fishGif');
                img.src = level === 1 ? GIFS.lv1 : (level === 2 ? GIFS.lv2 : GIFS.lv3);

                const st = document.getElementById('lixiStatus');
                if(userData.used_lixi === "allowed") st.innerText = "‚óè B·∫°n ƒëang c√≥ 1 l∆∞·ª£t m·ªü bao qu√†!";
                else if(userData.used_lixi === "received") st.innerText = "‚úì B·∫°n ƒë√£ nh·∫≠n qu√† r·ªìi.";
                else st.innerText = "‚óã B·∫°n ch∆∞a ƒë∆∞·ª£c c·∫•p quy·ªÅn m·ªü qu√†.";

                const sorted = allData.filter(u => u.username).sort((a, b) => (parseInt(b.level_score) || 0) - (parseInt(a.level_score) || 0));
                document.getElementById('leaderboardList').innerHTML = sorted.slice(0, 10).map((u, i) => {
                    const uLvl = Math.floor((parseInt(u.level_score) || 0) / 100) + 1;
                    return `<li>${i+1}. ${u.username} - Lv ${uLvl} - ${u.coins} Xu</li>`;
                }).join('');
            } catch (e) { console.error(e); }
        }

        async function openLuckyBox() {
            if (userData.used_lixi !== "allowed") {
                alert(userData.used_lixi === "received" ? "Npc xin tr·∫£ l·ªùi: B·∫°n ƒë√£ nh·∫≠n qu√† r·ªìi!" : "Npc xin tr·∫£ l·ªùi: B·∫°n ch∆∞a c√≥ t√™n trong danh s√°ch nh·∫≠n qu√†!");
                return;
            }

            const btn = document.getElementById('btnLixi');
            btn.disabled = true;

            try {
                const res = await fetch(FULL_URL);
                const allData = await res.json();
                const adminData = allData[0];
                let currentPool = parseInt(adminData.coins) || 0;

                if (currentPool <= 0) { alert("Npc xin tr·∫£ l·ªùi: Bao qu√† ƒë√£ h·∫øt!"); return; }

                // THU·∫¨T TO√ÅN √âP T·ªà L·ªÜ HI·∫æM
                let randomXu;
                let rate = Math.random() * 100;
                if (rate < 80) randomXu = Math.floor(Math.random() * 91) + 10; // 80% tr√∫ng 1k-10k
                else if (rate < 95) randomXu = Math.floor(Math.random() * 400) + 101; // 15% tr√∫ng 10k-50k
                else if (rate < 99.5) randomXu = Math.floor(Math.random() * 400) + 501; // 4.5% tr√∫ng 50k-90k
                else randomXu = Math.floor(Math.random() * 100) + 901; // 0.5% ƒê·ªòC ƒê·∫ÆC 100k

                if (randomXu > currentPool) randomXu = currentPool;

                if (confirm("Npc xin tr·∫£ l·ªùi: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën m·ªü BAO QU√Ä MAY M·∫ÆN n√†y?")) {
                    await fetch(FULL_URL, { method: "PUT", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ condition: {username: adminData.username}, set: { coins: currentPool - randomXu } })});
                    await fetch(FULL_URL, { method: "PUT", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ condition: {username: userData.username}, set: { coins: (parseInt(userData.coins) || 0) + randomXu, used_lixi: "received" } })});
                    
                    let msg = `Npc xin tr·∫£ l·ªùi: B·∫°n nh·∫≠n ƒë∆∞·ª£c ${randomXu} Xu (~${randomXu * 100} VNƒê).`;
                    if(randomXu >= 900) alert("üåü SI√äU C·∫§P MAY M·∫ÆN - ƒê·ªòC ƒê·∫ÆC! üåü\n" + msg);
                    else alert(msg);
                    location.reload();
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); }
            btn.disabled = false;
        }

        async function feedFish() {
            const now = Date.now();
            if (now - (parseInt(userData.last_feed) || 0) < 86400000) { alert("Npc xin tr·∫£ l·ªùi: C√° c√≤n no!"); return; }
            const lvl = Math.floor((parseInt(userData.level_score) || 0) / 100) + 1;
            let add = lvl === 1 ? (Math.floor(Math.random() * 10) + 1) : (lvl === 2 ? (Math.floor(Math.random() * 9) + 2) : (lvl === 3 ? (Math.floor(Math.random() * 10) + 2) : (Math.floor(Math.random() * 15) + 1)));
            await updateData({ coins: parseInt(userData.coins) + add, level_score: (parseInt(userData.level_score) || 0) + 10, last_feed: now });
            alert(`Npc xin tr·∫£ l·ªùi: C√° ƒÉn ngon qu√°! +10 XP v√† +${add} xu.`);
            location.reload();
        }

        async function buyFood() {
            const now = Date.now();
            if (now - (parseInt(userData.last_buy) || 0) < 86400000) { alert("Npc xin tr·∫£ l·ªùi: M·ªói ng√†y ch·ªâ mua ƒë∆∞·ª£c 1 l·∫ßn!"); return; }
            if (parseInt(userData.coins) < 10) { alert("Kh√¥ng ƒë·ªß xu!"); return; }
            if(confirm("D√πng 10 xu mua th·ª©c ƒÉn?")) {
                await updateData({ coins: parseInt(userData.coins) - 10, level_score: (parseInt(userData.level_score) || 0) + 10, last_buy: now });
                alert("Th√†nh c√¥ng! +10 XP."); location.reload();
            }
        }

        async function updateData(setData) {
            await fetch(FULL_URL, { method: "PUT", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ condition: {username: userData.username}, set: setData }) });
        }

        async function useGiftcode() {
            const code = prompt("Nh·∫≠p Giftcode:");
            if(!code) return;
            const valid = window.allGiftcodes.split(",").map(c => c.trim());
            let used = userData.used_lixi_codes ? userData.used_lixi_codes.split("|") : []; // D√πng c·ªôt kh√°c ƒë·ªÉ tr√°nh tr√πng lixi
            if(valid.includes(code) && !used.includes(code)) {
                setTimeout(async () => {
                    const add = Math.floor(Math.random() * 20) + 1;
                    used.push(code);
                    await updateData({ coins: parseInt(userData.coins) + add, used_lixi_codes: used.join("|") });
                    alert(`Npc xin tr·∫£ l·ªùi: +${add} xu!`); location.reload();
                }, 1000);
            } else { alert("M√£ sai ho·∫∑c ƒë√£ d√πng!"); }
        }
        init();
    </script>
</body>
</html>
