<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trang ch·ªß - H·ªá th·ªëng Npc</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <marquee id="marqueeTxt" class="marquee-style"></marquee>
    
    <div class="header-bar">
        <div class="balance">S·ªë d∆∞: <span id="userCoins">0</span> Xu ü™ô</div>
        <button class="gift-btn" onclick="useGiftcode()">NH·∫¨P GIFTCODE</button>
    </div>

    <div class="main-content">
        <div class="fish-section">
            <div class="fish-icon" id="fish">üêü</div>
            <button class="feed-btn" onclick="feedFish()">CHO C√Å ƒÇN (24H)</button>
        </div>

        <div id="adminInfo" class="info-box"></div>

        <div class="leaderboard-section">
            <h3>üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
            <ul id="leaderboardList"></ul>
        </div>
    </div>

    <script>
        // Npc xin tr·∫£ l·ªùi: API ƒë∆∞·ª£c chia nh·ªè ƒë·ªÉ b·∫£o m·∫≠t
        const p1 = "h" + "tt" + "ps://";
        const p2 = "api" + "." + "steinhq" + ".com";
        const p3 = "/v1/storages/";
        const p4 = "699" + "eda16" + "affba40a" + "6254160c"; 
        const FULL_URL = p1 + p2 + p3 + p4 + "/Sheet1";

        let userData = JSON.parse(localStorage.getItem("currentUser"));

        async function init() {
            if (!userData) { window.location.href = "index.html"; return; }

            try {
                const res = await fetch(FULL_URL);
                const allData = await res.json();
                const config = allData[0]; // L·∫•y d√≤ng ƒë·∫ßu ti√™n l√†m c·∫•u h√¨nh

                // Hi·ªÉn th·ªã d·ªØ li·ªáu t·ª´ Sheet
                document.getElementById('marqueeTxt').innerText = "TH√îNG B√ÅO: " + config.marquee_text;
                document.getElementById('adminInfo').innerText = config.info_box;
                document.getElementById('userCoins').innerText = userData.coins;
                
                // L∆∞u danh s√°ch Giftcode v√†o bi·∫øn to√†n c·ª•c
                window.allGiftcodes = config.giftcode_val;

                // C·∫≠p nh·∫≠t B·∫£ng x·∫øp h·∫°ng
                const sorted = allData.sort((a, b) => b.coins - a.coins);
                document.getElementById('leaderboardList').innerHTML = sorted.slice(0, 10).map(u => 
                    `<li><span>${u.username}</span> <span>${u.coins} Xu</span></li>`
                ).join('');
            } catch (e) {
                console.log("L·ªói t·∫£i d·ªØ li·ªáu!");
            }
        }

        async function feedFish() {
            const now = Date.now();
            const lastFeed = parseInt(userData.last_feed) || 0;

            if (now - lastFeed < 86400000) {
                alert("C√° ƒë√£ no r·ªìi, h√£y quay l·∫°i sau 24 gi·ªù!");
                return;
            }

            const add = Math.floor(Math.random() * 3) + 1;
            const newCoins = parseInt(userData.coins) + add;
            
            await updateSheet({ coins: newCoins, last_feed: now });
            alert(`Npc xin tr·∫£ l·ªùi: C√° ƒë√£ ƒÉn v√† t·∫∑ng b·∫°n ${add} xu!`);
            location.reload();
        }

        async function useGiftcode() {
            if (userData.used_giftcode === "yes") {
                alert("M·ªói t√†i kho·∫£n ch·ªâ ƒë∆∞·ª£c nh·∫≠n Giftcode m·ªôt l·∫ßn duy nh·∫•t!");
                return;
            }

            const codeInp = prompt("Nh·∫≠p m√£ Giftcode c·ªßa b·∫°n:");
            if (!codeInp) return;

            // Chuy·ªÉn chu·ªói code t·ª´ Sheet th√†nh danh s√°ch (m·∫£ng)
            const listValidCodes = window.allGiftcodes.split(",").map(c => c.trim());

            if (listValidCodes.includes(codeInp)) {
                alert("M√£ ch√≠nh x√°c! Vui l√≤ng ch·ªù 1 gi√¢y...");
                
                // ƒê√£ ch·ªânh th·ªùi gian ch·ªù xu·ªëng 1 gi√¢y (1000ms)
                setTimeout(async () => {
                    const add = Math.floor(Math.random() * 20) + 1;
                    const newTotal = parseInt(userData.coins) + add;

                    await updateSheet({ 
                        coins: newTotal, 
                        used_giftcode: "yes" 
                    });

                    alert(`Npc xin tr·∫£ l·ªùi: Ch√∫c m·ª´ng! B·∫°n nh·∫≠n ƒë∆∞·ª£c ${add} xu.`);
                    location.reload();
                }, 1000);
            } else {
                alert("M√£ Giftcode kh√¥ng ƒë√∫ng ho·∫∑c kh√¥ng t·ªìn t·∫°i!");
            }
        }

        async function updateSheet(setData) {
            try {
                await fetch(FULL_URL, {
                    method: "PUT",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ 
                        condition: {username: userData.username}, 
                        set: setData 
                    })
                });
                // C·∫≠p nh·∫≠t l·∫°i b·ªô nh·ªõ t·∫°m c·ªßa tr√¨nh duy·ªát
                userData = {...userData, ...setData};
                localStorage.setItem("currentUser", JSON.stringify(userData));
            } catch (e) {
                alert("L·ªói khi c·∫≠p nh·∫≠t d·ªØ li·ªáu!");
            }
        }

        init();
    </script>
</body>
</html>
