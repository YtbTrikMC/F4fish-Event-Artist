<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trang ch·ªß - H·ªá th·ªëng Npc</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Gi·ªØ nguy√™n CSS c≈© c·ªßa b·∫°n ho·∫∑c d√πng b·∫£n t·ªëi ∆∞u n√†y */
        .level-container { width: 100%; background: #ddd; border-radius: 10px; margin: 10px 0; position: relative; height: 20px; overflow: hidden; }
        .level-bar { height: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); width: 0%; transition: 0.5s; }
        .level-text { position: absolute; width: 100%; text-align: center; font-size: 12px; line-height: 20px; font-weight: bold; color: #000; z-index: 1; }
        .fish-gif { width: 150px; height: auto; display: block; margin: 0 auto; cursor: pointer; }
    </style>
</head>
<body>
    <marquee id="marqueeTxt" class="marquee-style">ƒêang t·∫£i...</marquee>
    
    <div class="header-bar">
        <div class="balance">Xu: <span id="userCoins">0</span> ü™ô | Level: <span id="userLevel">1</span></div>
        <button class="gift-btn" onclick="useGiftcode()">GIFTCODE</button>
    </div>

    <div class="main-content">
        <div class="level-container">
            <div class="level-text" id="levelScoreTxt">0/100 XP</div>
            <div class="level-bar" id="levelBar"></div>
        </div>

        <div class="fish-section">
            <img src="" id="fishGif" class="fish-gif" onclick="feedFish()" alt="C√°">
            <button id="btnFeed" class="feed-btn" onclick="feedFish()">CHO C√Å ƒÇN (MI·ªÑN PH√ç 24H)</button>
        </div>

        <div class="shop-section" style="margin-top:15px; border:1px dashed blue; padding:10px;">
            <p style="font-size:12px;">C·ª≠a h√†ng: 10 xu = +10 XP</p>
            <button id="btnBuy" onclick="buyFood()" style="background:orange; padding:5px;">MUA TH·ª®C ƒÇN (1 L·∫¶N/NG√ÄY)</button>
        </div>

        <div id="adminInfo" class="info-box" style="margin-top:10px;"></div>

        <div class="leaderboard-section">
            <h3>üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
            <ul id="leaderboardList"></ul>
        </div>
    </div>

    <script>
        const p1 = "h" + "tt" + "ps://";
        const p2 = "api" + "." + "steinhq" + ".com";
        const p3 = "/v1/storages/";
        const p4 = "699" + "eda16" + "affba40a" + "6254160c"; 
        const FULL_URL = p1 + p2 + p3 + p4 + "/Sheet1";

        let userData = JSON.parse(localStorage.getItem("currentUser"));

        const GIFS = {
            lv1: "https://image2url.com/r2/default/gifs/1772020990089-c0dba8da-4cd7-4f28-b2e8-8fc7eb632f26.gif",
            lv2: "https://image2url.com/r2/default/gifs/1772021046327-83a1abb8-5bc1-47a7-888e-34918c5a1410.gif",
            lv3: "https://image2url.com/r2/default/gifs/1772021071582-773603d9-15ed-4bb0-a37f-6d801ccd3639.gif"
        };

        async function init() {
            if (!userData) { window.location.href = "index.html"; return; }
            try {
                // T·∫£i d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ Stein ƒë·ªÉ tr√°nh hack/l·ªói lag
                const res = await fetch(FULL_URL);
                const allData = await res.json();
                
                // C·∫≠p nh·∫≠t l·∫°i userData t·ª´ Server
                const freshData = allData.find(u => u.username === userData.username);
                if(freshData) {
                    userData = freshData;
                    localStorage.setItem("currentUser", JSON.stringify(freshData));
                }

                const config = allData[0];
                const score = parseInt(userData.level_score) || 0;
                const level = Math.floor(score / 100) + 1;
                const xpInLevel = score % 100;

                // C·∫≠p nh·∫≠t UI
                document.getElementById('userLevel').innerText = level;
                document.getElementById('userCoins').innerText = userData.coins;
                document.getElementById('levelBar').style.width = xpInLevel + "%";
                document.getElementById('levelScoreTxt').innerText = xpInLevel + "/100 XP";
                document.getElementById('marqueeTxt').innerText = "TH√îNG B√ÅO: " + (config.marquee_text || "");
                document.getElementById('adminInfo').innerText = config.info_box || "";
                window.allGiftcodes = config.giftcode_val || "";

                // ƒê·ªïi GIF
                const img = document.getElementById('fishGif');
                if (level === 1) img.src = GIFS.lv1;
                else if (level === 2) img.src = GIFS.lv2;
                else img.src = GIFS.lv3;

                // B·∫£ng x·∫øp h·∫°ng (S·∫Øp x·∫øp theo level_score gi·∫£m d·∫ßn)
                const sorted = allData
                    .filter(u => u.username)
                    .sort((a, b) => (parseInt(b.level_score) || 0) - (parseInt(a.level_score) || 0));
                
                document.getElementById('leaderboardList').innerHTML = sorted.slice(0, 10).map((u, i) => {
                    const uLvl = Math.floor((parseInt(u.level_score) || 0) / 100) + 1;
                    return `<li>${i+1}. ${u.username} - [Lv ${uLvl}] - ${u.coins} Xu</li>`;
                }).join('');

            } catch (e) { console.error("L·ªói init:", e); }
        }

        async function feedFish() {
            const btn = document.getElementById('btnFeed');
            const now = Date.now();
            const last = parseInt(userData.last_feed) || 0;

            if (now - last < 86400000) {
                const hoursLeft = Math.ceil((86400000 - (now - last)) / 3600000);
                alert(`Npc xin tr·∫£ l·ªùi: C√° c√≤n no, quay l·∫°i sau ${hoursLeft} gi·ªù n·ªØa!`);
                return;
            }

            btn.disabled = true;
            await processAction(now, 0, null);
        }

        async function buyFood() {
            const btn = document.getElementById('btnBuy');
            const now = Date.now();
            const lastBuy = parseInt(userData.last_buy) || 0;

            if (now - lastBuy < 86400000) {
                alert("Npc xin tr·∫£ l·ªùi: M·ªói ng√†y ch·ªâ mua ƒë∆∞·ª£c 1 l·∫ßn th√¥i!"); return;
            }
            if (parseInt(userData.coins) < 10) {
                alert("B·∫°n kh√¥ng ƒë·ªß 10 xu!"); return;
            }

            if(confirm("D√πng 10 xu ƒë·ªÉ mua th√™m th·ª©c ƒÉn?")) {
                btn.disabled = true;
                await processAction(userData.last_feed, 10, now);
            }
        }

        async function processAction(feedT, cost, buyT) {
            const score = parseInt(userData.level_score) || 0;
            const lvl = Math.floor(score / 100) + 1;
            
            // T√≠nh xu theo Level b·∫°n ƒë√£ y√™u c·∫ßu
            let add = 0;
            if (lvl === 1) add = Math.floor(Math.random() * 20) + 1;
            else if (lvl === 2) add = Math.floor(Math.random() * 25) + 1;
            else if (lvl === 3) add = Math.floor(Math.random() * 24) + 2;
            else add = Math.floor(Math.random() * 23) + 3;

            const newData = {
                coins: (parseInt(userData.coins) + add - cost),
                level_score: score + 10,
                last_feed: feedT
            };
            if(buyT) newData.last_buy = buyT;

            try {
                await fetch(FULL_URL, {
                    method: "PUT",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ condition: {username: userData.username}, set: newData })
                });
                alert(`Npc xin tr·∫£ l·ªùi: Th√†nh c√¥ng! +10 XP v√† ${add} xu.`);
                location.reload();
            } catch (e) { alert("L·ªói k·∫øt n·ªëi Server!"); location.reload(); }
        }

        async function useGiftcode() {
            const code = prompt("Nh·∫≠p Giftcode:");
            if(!code) return;
            const valid = window.allGiftcodes.split(",").map(c => c.trim());
            let used = userData.used_giftcode ? userData.used_giftcode.split("|") : [];

            if(valid.includes(code) && !used.includes(code)) {
                alert("ƒêang x·ª≠ l√Ω (1s)...");
                setTimeout(async () => {
                    const add = Math.floor(Math.random() * 20) + 1;
                    used.push(code);
                    await fetch(FULL_URL, {
                        method: "PUT",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({ 
                            condition: {username: userData.username}, 
                            set: { coins: parseInt(userData.coins) + add, used_giftcode: used.join("|") } 
                        })
                    });
                    alert(`Npc xin tr·∫£ l·ªùi: +${add} xu!`);
                    location.reload();
                }, 1000);
            } else { alert("M√£ sai ho·∫∑c ƒë√£ d√πng!"); }
        }

        init();
    </script>
</body>
</html>
