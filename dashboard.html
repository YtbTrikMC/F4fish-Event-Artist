<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trang ch·ªß - Artist</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <marquee id="marqueeTxt" class="marquee-style">ƒêang t·∫£i th√¥ng b√°o t·ª´ h·ªá th·ªëng...</marquee>

    <div class="header-bar">
        <div class="balance">S·ªë d∆∞: <span id="userCoins">0</span> Xu ü™ô</div>
        <button class="gift-btn" onclick="useGiftcode()">NH·∫¨P GIFTCODE</button>
    </div>

    <div class="main-content">
        <div class="fish-section">
            <div class="fish-icon" id="fish">üêü</div>
            <button class="feed-btn" id="feedBtn" onclick="feedFish()">CHO C√Å ƒÇN (24H)</button>
        </div>

        <div id="adminInfo" class="info-box">ƒêang t·∫£i th√¥ng tin...</div>

        <div class="leaderboard-section">
            <h3>üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
            <ul id="leaderboardList"></ul>
        </div>
    </div>

    <script>
        const p1 = "h" + "tt" + "ps://";
        const p2 = "api" + "." + "steinhq" + ".com";
        const p3 = "/v1/storages/";
        const p4 = "699" + "ed5d6" + "affba40a" + "625413ac";
        const FULL_URL = p1 + p2 + p3 + p4 + "/Sheet1";

        let userData = JSON.parse(localStorage.getItem("currentUser"));

        async function init() {
            if (!userData) { window.location.href = "index.html"; return; }

            const res = await fetch(FULL_URL);
            const allData = await res.json();
            const config = allData[0]; // D√≤ng ƒë·∫ßu ti√™n

            // Hi·ªÉn th·ªã th√¥ng tin
            document.getElementById('marqueeTxt').innerText = "TH√îNG B√ÅO: " + config.marquee_text;
            document.getElementById('adminInfo').innerText = config.info_box;
            document.getElementById('userCoins').innerText = userData.coins;
            window.currentGiftcode = config.giftcode_val;

            // B·∫£ng x·∫øp h·∫°ng
            const sorted = allData.sort((a, b) => b.coins - a.coins);
            document.getElementById('leaderboardList').innerHTML = sorted.slice(0, 10).map(u => 
                `<li><span>${u.username}</span> <span>${u.coins} Xu</span></li>`
            ).join('');
        }

        async function feedFish() {
            const now = Date.now();
            const lastFeed = parseInt(userData.last_feed) || 0;

            if (now - lastFeed < 86400000) {
                alert("C√° ƒë√£ no r·ªìi, h√£y quay l·∫°i sau 24 gi·ªù!");
                return;
            }

            const add = Math.floor(Math.random() * 3) + 1;
            const newCoins = parseInt(userData.coins) + add;
            
            await updateSheet({ coins: newCoins, last_feed: now });
            alert(`Npc xin tr·∫£ l·ªùi: B·∫°n nh·∫≠n ƒë∆∞·ª£c ${add} xu!`);
            location.reload();
        }

        async function useGiftcode() {
            if (localStorage.getItem('gift_lock') > Date.now()) {
                alert("B·∫°n ƒëang b·ªã kh√≥a ch·ª©c nƒÉng n√†y 1 ti·∫øng!"); return;
            }
            if (userData.used_giftcode === "yes") {
                alert("T√†i kho·∫£n n√†y ƒë√£ nh·∫≠n qu√† r·ªìi!"); return;
            }

            const code = prompt("Nh·∫≠p m√£ Giftcode:");
            if (code === window.currentGiftcode) {
                alert("ƒêang x√°c th·ª±c... Ch·ªù 30s ƒë·ªÉ nh·∫≠n xu ng·∫´u nhi√™n.");
                setTimeout(async () => {
                    const add = Math.floor(Math.random() * 20) + 1;
                    await updateSheet({ coins: parseInt(userData.coins) + add, used_giftcode: "yes" });
                    alert(`Npc xin tr·∫£ l·ªùi: Ch√∫c m·ª´ng! B·∫°n nh·∫≠n ƒë∆∞·ª£c ${add} xu.`);
                    location.reload();
                }, 30000);
            } else {
                localStorage.setItem('gift_lock', Date.now() + 3600000); // Kh√≥a 1 ti·∫øng
                alert("Sai m√£! B·∫°n b·ªã kh√≥a ch·ª©c nƒÉng n√†y 1 ti·∫øng.");
            }
        }

        async function updateSheet(setData) {
            await fetch(FULL_URL, {
                method: "PUT",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ condition: {username: userData.username}, set: setData })
            });
            // C·∫≠p nh·∫≠t l·∫°i local
            userData = {...userData, ...setData};
            localStorage.setItem("currentUser", JSON.stringify(userData));
        }

        init();
    </script>
</body>
</html>
