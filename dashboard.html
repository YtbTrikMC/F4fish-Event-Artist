<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Art</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .level-container { width: 100%; background: #ddd; border-radius: 10px; margin: 10px 0; position: relative; height: 22px; overflow: hidden; }
        .level-bar { height: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); width: 0%; transition: 0.5s; }
        .level-text { position: absolute; width: 100%; text-align: center; font-size: 12px; line-height: 22px; font-weight: bold; color: #000; z-index: 1; }
        .lucky-box-section { margin: 20px auto; padding: 15px; max-width: 400px; background: linear-gradient(145deg, #ff4757, #e84118); border: 3px solid #fbc531; border-radius: 15px; color: white; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .lucky-btn { background: #fbc531; color: #c23616; font-weight: bold; border: none; padding: 12px 30px; border-radius: 25px; cursor: pointer; text-transform: uppercase; }
        
        /* INFO BOX ADMIN */
        .info-box { background: #fff3cd; border-left: 5px solid #ffc107; padding: 10px; margin: 15px auto; max-width: 400px; font-size: 13px; color: #856404; text-align: left; }
        
        /* NH·∫¨T K√ù */
        .history-box { margin: 15px auto; max-width: 400px; background: #fff; border: 1px solid #34495e; border-radius: 8px; overflow: hidden; }
        .history-header { background: #34495e; color: white; padding: 6px; font-weight: bold; font-size: 13px; text-align: center; }
        .history-list { height: 100px; overflow-y: auto; padding: 8px; font-size: 12px; list-style: none; margin: 0; text-align: left; }
        .history-list li { border-bottom: 1px solid #eee; padding: 4px 0; color: #333; }

        .rank-tabs { display: flex; gap: 5px; margin-top: 15px; justify-content: center; }
        .tab-btn { padding: 8px 15px; border: none; background: #ecf0f1; cursor: pointer; border-radius: 5px 5px 0 0; font-weight: bold; }
        .tab-btn.active { background: #3498db; color: white; }
        .rank-list { list-style: none; padding: 10px; background: #fff; border: 1px solid #ddd; border-top: none; margin: 0 auto; max-width: 400px; border-radius: 0 0 5px 5px; }
        .rank-list li { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 14px; }
    </style>
</head>
<body>
    <marquee id="fixedMsg" style="background: #2980b9; color: white; padding: 5px; font-weight: bold;">ƒêang t·∫£i th√¥ng b√°o...</marquee>
    
    <div class="header-bar">
        <div class="balance">Xu: <span id="userCoins">0</span> ü™ô | Level: <span id="userLevel">1</span></div>
        <button class="gift-btn" onclick="useGiftcode()" style="background:#fbc531; border:none; padding:5px 10px; border-radius:5px; font-weight:bold; cursor:pointer;">GIFTCODE</button>
    </div>

    <div class="main-content">
        <div class="info-box" id="adminNotice">
            <b>üì¢ TH√îNG B√ÅO ADMIN:</b><br>
            - 1 Xu = 100 VNƒê. ƒê·ªß 100 Xu quy ƒë·ªïi 10k.<br>
            - Tuy·ªát ƒë·ªëi kh√¥ng gian l·∫≠n.
        </div>

        <div class="level-container"><div class="level-text" id="levelScoreTxt">0/100 XP</div><div class="level-bar" id="levelBar"></div></div>
        
        <div class="fish-section" style="text-align: center; padding: 10px;">
            <img src="" id="fishGif" style="width: 90px; cursor: pointer;" onclick="feedFish()">
            <br><button id="btnFeed" onclick="feedFish()" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 5px;">CHO C√Å ƒÇN (24H)</button>
        </div>

        <div class="lucky-box-section">
            <h2>üßß BAO QU√Ä MAY M·∫ÆN</h2>
            <p>Qu·ªπ t·∫∑ng c√≤n: <span id="poolCoins" style="font-weight:bold; color:#fbc531;">0</span> Xu</p>
            <button id="btnLixi" class="lucky-btn" onclick="openLuckyBox()">M·ªû QU√Ä NGAY</button>
            <p id="lixiStatus" style="font-size: 11px; margin-top: 5px; font-weight: bold;"></p>
        </div>

        <div class="history-box">
            <div class="history-header">üìú NH·∫¨T K√ù NH·∫¨N QU√Ä</div>
            <ul id="historyList" class="history-list"><li>Ch∆∞a c√≥ nh·∫≠t k√Ω...</li></ul>
        </div>

        <h3 style="text-align: center; margin-top: 20px;">üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
        <div class="rank-tabs">
            <button id="tabXu" class="tab-btn active" onclick="switchRank('xu')">TOP XU</button>
            <button id="tabLixi" class="tab-btn" onclick="switchRank('lixi')">TOP L∆Ø·ª¢T QU√Ä</button>
        </div>
        <ul id="leaderboardList" class="rank-list"></ul>
    </div>

    <script>
        const p1 = "https://api.steinhq.com/v1/storages/699eda16affba40a6254160c/Sheet1";
        let userData = JSON.parse(localStorage.getItem("currentUser"));
        let globalData = [];
        const GIFS = {
            lv1: "https://image2url.com/r2/default/gifs/1772020990089-c0dba8da-4cd7-4f28-b2e8-8fc7eb632f26.gif",
            lv2: "https://image2url.com/r2/default/gifs/1772021046327-83a1abb8-5bc1-47a7-888e-34918c5a1410.gif",
            lv3: "https://image2url.com/r2/default/gifs/1772021071582-773603d9-15ed-4bb0-a37f-6d801ccd3639.gif"
        };

        async function init() {
            try {
                const res = await fetch(p1);
                globalData = await res.json();
                const fresh = globalData.find(u => u.username === userData.username);
                if(fresh) { userData = fresh; localStorage.setItem("currentUser", JSON.stringify(userData)); }

                document.getElementById('fixedMsg').innerText = globalData[0].marquee_text || "Ch√†o m·ª´ng!";
                loadLogs();
                updateUI();
                switchRank('xu');
            } catch (e) { console.error("L·ªói t·∫£i data"); }
        }

        function loadLogs() {
            const historyEl = document.getElementById('historyList');
            if(globalData[0].lixi_log) {
                const logs = globalData[0].lixi_log.split("|").filter(x => x !== "");
                historyEl.innerHTML = logs.reverse().map(log => `<li>${log}</li>`).join('');
            }
        }

        function updateUI() {
            document.getElementById('userCoins').innerText = userData.coins;
            const admin = globalData.find(u => u.username === "admin");
            document.getElementById('poolCoins').innerText = admin ? admin.coins : "0";
            document.getElementById('lixiStatus').innerText = `B·∫°n c√≤n ${userData.lixi_count || 0} l∆∞·ª£t m·ªü qu√†!`;
            
            const score = parseInt(userData.level_score) || 0;
            const level = Math.floor(score / 100) + 1;
            document.getElementById('userLevel').innerText = level;
            document.getElementById('levelBar').style.width = (score % 100) + "%";
            document.getElementById('levelScoreTxt').innerText = (score % 100) + "/100 XP";
            document.getElementById('fishGif').src = level === 1 ? GIFS.lv1 : (level === 2 ? GIFS.lv2 : GIFS.lv3);
        }

        async function openLuckyBox() {
            let count = parseInt(userData.lixi_count) || 0;
            if (count <= 0) { alert("Npc xin tr·∫£ l·ªùi: H·∫øt l∆∞·ª£t r·ªìi!"); return; }
            const btn = document.getElementById('btnLixi');
            btn.disabled = true;

            try {
                let randomXu = Math.floor(Math.random() * 81) + 20; 
                let money = randomXu * 100;

                if (confirm(`S·ª≠ d·ª•ng 1 l∆∞·ª£t ƒë·ªÉ m·ªü qu√†?`)) {
                    // 1. C·∫≠p nh·∫≠t Nh·∫≠t k√Ω (Th√™m m·ªõi v√†o chu·ªói c≈©)
                    const newEntry = `‚úîÔ∏è <b>${userData.username}</b> nh·∫≠n ${randomXu} Xu (~${money}ƒë)`;
                    let updatedLogs = (globalData[0].lixi_log || "") + "|" + newEntry;
                    await fetch(p1, { method: "PUT", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ condition: {username: "config_row"}, set: { lixi_log: updatedLogs } })});
                    
                    // 2. Tr·ª´ qu·ªπ Admin & Tr·ª´ l∆∞·ª£t/C·ªông xu User
                    const adminCoins = parseInt(globalData.find(u=>u.username==="admin").coins) - randomXu;
                    await fetch(p1, { method: "PUT", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ condition: {username: "admin"}, set: { coins: adminCoins } })});
                    
                    userData.coins = (parseInt(userData.coins) || 0) + randomXu;
                    userData.lixi_count = count - 1;
                    await fetch(p1, { method: "PUT", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ condition: {username: userData.username}, set: { coins: userData.coins, lixi_count: userData.lixi_count } })});
                    
                    alert(`Npc xin tr·∫£ l·ªùi: Ch√∫c m·ª´ng! B·∫°n nh·∫≠n ƒë∆∞·ª£c ${randomXu} Xu (~${money}ƒë)!`);
                    localStorage.setItem("currentUser", JSON.stringify(userData));
                    
                    // C·∫≠p nh·∫≠t UI t·∫°i ch·ªó, kh√¥ng reload
                    updateUI();
                    globalData[0].lixi_log = updatedLogs; // C·∫≠p nh·∫≠t log ·∫£o ƒë·ªÉ hi·ªán lu√¥n
                    loadLogs(); 
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); }
            btn.disabled = false;
        }

        async function feedFish() {
            const now = Date.now();
            if (now - (parseInt(userData.last_feed) || 0) < 86400000) { alert("C√° no r·ªìi!"); return; }
            let add = Math.floor(Math.random() * 10) + 5;
            userData.coins = (parseInt(userData.coins) || 0) + add;
            userData.level_score = (parseInt(userData.level_score) || 0) + 10;
            userData.last_feed = now;
            await fetch(p1, { method: "PUT", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ condition: {username: userData.username}, set: { coins: userData.coins, level_score: userData.level_score, last_feed: now } })});
            alert(`Npc xin tr·∫£ l·ªùi: +10 XP v√† +${add} xu.`);
            updateUI();
            localStorage.setItem("currentUser", JSON.stringify(userData));
        }

        function switchRank(type) {
            const list = document.getElementById('leaderboardList');
            document.getElementById('tabXu').className = type === 'xu' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tabLixi').className = type === 'lixi' ? 'tab-btn active' : 'tab-btn';
            let sorted = [...globalData].sort((a, b) => (parseInt(b[type === 'xu' ? 'coins' : 'lixi_count']) || 0) - (parseInt(a[type === 'xu' ? 'coins' : 'lixi_count']) || 0));
            list.innerHTML = sorted.slice(0, 10).map((u, i) => `<li><span>${i+1}. ${u.username}</span> <b>${type === 'xu' ? u.coins + ' Xu' : (u.lixi_count || 0) + ' L∆∞·ª£t'}</b></li>`).join('');
        }

        async function useGiftcode() {
            let code = prompt("Nh·∫≠p Giftcode:");
            if(!code) return;
            const myGiftcodes = ["TANTHU", "LIXI888", "NPCVIP"]; 
            if(myGiftcodes.includes(code.toUpperCase())) {
                userData.lixi_count = (parseInt(userData.lixi_count) || 0) + 5;
                await fetch(p1, { method: "PUT", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ condition: {username: userData.username}, set: { lixi_count: userData.lixi_count } })});
                alert("Npc xin tr·∫£ l·ªùi: +5 l∆∞·ª£t m·ªü qu√†!");
                updateUI();
            } else { alert("Sai m√£!"); }
        }

        init();
    </script>
</body>
</html>
