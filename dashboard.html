<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - NPC H·ªá Th·ªëng</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- STYLE GI·ªÆ NGUY√äN --- */
        .level-container { width: 100%; background: #ddd; border-radius: 10px; margin: 10px 0; position: relative; height: 22px; overflow: hidden; }
        .level-bar { height: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); width: 0%; transition: 0.5s; }
        .level-text { position: absolute; width: 100%; text-align: center; font-size: 12px; line-height: 22px; font-weight: bold; color: #000; z-index: 1; }
        .lucky-box-section { margin: 20px auto; padding: 15px; max-width: 400px; background: linear-gradient(145deg, #ff4757, #e84118); border: 3px solid #fbc531; border-radius: 15px; color: white; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .lucky-btn { background: #fbc531; color: #c23616; font-weight: bold; border: none; padding: 12px 30px; border-radius: 25px; cursor: pointer; text-transform: uppercase; }
        .info-box { background: #fff3cd; border-left: 5px solid #ffc107; padding: 10px; margin: 15px auto; max-width: 400px; font-size: 13px; color: #856404; text-align: left; }
        .history-box { margin: 15px auto; max-width: 400px; background: #fff; border: 1px solid #34495e; border-radius: 8px; overflow: hidden; }
        .history-header { background: #34495e; color: white; padding: 6px; font-weight: bold; font-size: 13px; text-align: center; }
        .history-list { height: 100px; overflow-y: auto; padding: 8px; font-size: 12px; list-style: none; margin: 0; text-align: left; }
        .history-list li { border-bottom: 1px solid #eee; padding: 4px 0; color: #333; }
        .rank-tabs { display: flex; gap: 5px; margin-top: 15px; justify-content: center; }
        .tab-btn { padding: 8px 15px; border: none; background: #ecf0f1; cursor: pointer; border-radius: 5px 5px 0 0; font-weight: bold; }
        .tab-btn.active { background: #3498db; color: white; }
        .rank-list { list-style: none; padding: 10px; background: #fff; border: 1px solid #ddd; border-top: none; margin: 0 auto; max-width: 400px; border-radius: 0 0 5px 5px; }
        .rank-list li { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 14px; }

        /* --- STYLE CASE OPENING M·ªöI --- */
        .case-section { background: #1a1a1b; padding: 15px; border-radius: 12px; border: 2px solid #444; margin: 15px auto; max-width: 400px; color: white; text-align: center; }
        #singleView { position: relative; width: 100%; height: 100px; background: #2b2b2b; overflow: hidden; display: flex; align-items: center; border-radius: 5px; margin-bottom: 10px; }
        .pointer { position: absolute; left: 50%; top: 0; bottom: 0; width: 3px; background: #ff4757; z-index: 10; transform: translateX(-50%); }
        #shuffler { display: flex; position: absolute; left: 0; }
        .case-item { min-width: 90px; height: 90px; background: #333; border-bottom: 4px solid #ccc; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; margin-right: 2px; }
        .r-1 { border-color: #4b69ff; color: #4b69ff; }
        .r-0 { border-color: #576574; color: #8395a7; } /* M√†u nh·∫°t cho 0 xu */
        .r-10 { border-color: #d32ee6; color: #d32ee6; }
        .r-50 { border-color: #eb4b4b; color: #eb4b4b; background: linear-gradient(to bottom, #333, #4b2b2b); }
        .multi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; display: none; }
        #totalSpinsDisplay { color: #2ecc71; font-size: 12px; font-weight: bold; margin-bottom: 5px; }
    </style>
</head>
<body>
    <marquee id="fixedMsg" style="background: #2980b9; color: white; padding: 5px; font-weight: bold;">ƒêang t·∫£i...</marquee>
    
    <div class="header-bar">
        <div class="balance">Xu: <span id="userCoins">0</span> ü™ô | Level: <span id="userLevel">1</span></div>
        <button class="gift-btn" onclick="useGiftcode()">GIFTCODE</button>
    </div>

    <div class="main-content">
        <div class="info-box" id="adminNotice">
            <b>üì¢ TH√îNG B√ÅO ADMIN:</b><br>
            - T·ª∑ l·ªá quay h√≤m ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t c·ª±c kh√≥!<br>
            - ƒê·ªß 100 Xu quy ƒë·ªïi qu√†.
        </div>

        <div class="case-section">
            <h4 style="margin: 0; color: #f1c40f;">üé∞ NPC CASE OPENING PRO</h4>
            <div id="totalSpinsDisplay">ƒê√£ nghi·ªán quay: 0 l∆∞·ª£t</div>
            <div id="singleView">
                <div class="pointer"></div>
                <div id="shuffler"></div>
            </div>
            <div id="multiView" class="multi-grid"></div>
            <div id="caseStatus" style="font-size: 11px; margin-bottom: 10px; color: #aaa;">S·∫µn s√†ng!</div>
            <div style="display: flex; gap: 8px;">
                <button id="btnSpin1" onclick="spinCase(1)" style="flex:1; background:#3498db; color:white; border:none; padding:8px; border-radius:5px; font-weight:bold; cursor:pointer;">QUAY 1 (1 XU)</button>
                <button id="btnSpin10" onclick="spinCase(10)" style="flex:1; background:#f1c40f; color:black; border:none; padding:8px; border-radius:5px; font-weight:bold; cursor:pointer;">QUAY 10 (10 XU)</button>
            </div>
        </div>

        <div class="lucky-box-section">
            <h2>üßß BAO QU√Ä MAY M·∫ÆN</h2>
            <p>Qu·ªπ t·∫∑ng c√≤n: <span id="poolCoins" style="color:#fbc531;">0</span> Xu</p>
            <button id="btnLixi" class="lucky-btn" onclick="openLuckyBox()">M·ªû QU√Ä NGAY</button>
            <p id="lixiStatus" style="font-size: 11px; margin-top: 5px; font-weight: bold;"></p>
        </div>

        <div class="history-box">
            <div class="history-header">üìú NH·∫¨T K√ù NH·∫¨N QU√Ä</div>
            <ul id="historyList" class="history-list"></ul>
        </div>

        <h3 style="text-align: center; margin-top: 20px;">üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
        <div class="rank-tabs">
            <button id="tabXu" class="tab-btn active" onclick="switchRank('xu')">TOP XU</button>
            <button id="tabLixi" class="tab-btn" onclick="switchRank('lixi')">TOP QU√Ä</button>
        </div>
        <ul id="leaderboardList" class="rank-list"></ul>
    </div>

    <script>
        const p1 = "https://api.steinhq.com/v1/storages/699eda16affba40a6254160c/Sheet1";
        let userData = JSON.parse(localStorage.getItem("currentUser"));
        let globalData = [];

        // --- GI·∫¢I PH·∫™U T·ª∂ L·ªÜ M·ªöI (0 XU CHI·∫æM 60%) ---
        const caseConfig = [
            { label: "0 XU", value: 0, weight: 60, class: "r-0" },    // Tr∆∞·ª£t (60%)
            { label: "1 XU", value: 1, weight: 33.5, class: "r-1" }, // Hu·ªÅ (33.5%)
            { label: "10 XU", value: 10, weight: 6, class: "r-10" },  // L√£i (6%)
            { label: "50 XU", value: 50, weight: 0.5, class: "r-50" } // Jackpot (0.5%)
        ];

        async function init() {
            try {
                const res = await fetch(p1);
                globalData = await res.json();
                const fresh = globalData.find(u => u.username === userData.username);
                if(fresh) { userData = fresh; localStorage.setItem("currentUser", JSON.stringify(userData)); }
                document.getElementById('fixedMsg').innerText = globalData[0].marquee_text || "Ch√†o m·ª´ng Npc!";
                loadLogs();
                updateUI();
                switchRank('xu');
            } catch (e) { console.error("L·ªói kh·ªüi t·∫°o"); }
        }

        function updateUI() {
            document.getElementById('userCoins').innerText = userData.coins;
            document.getElementById('userLevel').innerText = Math.floor((parseInt(userData.level_score) || 0) / 100) + 1;
            document.getElementById('lixiStatus').innerText = `B·∫°n c√≤n ${userData.lixi_count || 0} l∆∞·ª£t m·ªü qu√†!`;
            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£t nghi·ªán
            document.getElementById('totalSpinsDisplay').innerText = `ƒê√£ nghi·ªán quay: ${userData.total_spins || 0} l∆∞·ª£t`;
            
            const admin = globalData.find(u => u.username === "admin");
            document.getElementById('poolCoins').innerText = admin ? admin.coins : "0";
        }

        function getRandItem() {
            let rand = Math.random() * 100;
            let sum = 0;
            for (let item of caseConfig) {
                sum += item.weight;
                if (rand <= sum) return item;
            }
        }

        async function spinCase(times) {
            let currentCoins = parseInt(userData.coins) || 0;
            if (currentCoins < times) { alert("Npc xin tr·∫£ l·ªùi: Kh√¥ng ƒë·ªß Xu!"); return; }

            document.getElementById('btnSpin1').disabled = true;
            document.getElementById('btnSpin10').disabled = true;
            
            // TR·ª™ TI·ªÄN V√Ä TƒÇNG L∆Ø·ª¢T NGHI·ªÜN NGAY L·∫¨P T·ª®C
            userData.coins = currentCoins - times;
            userData.total_spins = (parseInt(userData.total_spins) || 0) + times;
            updateUI();

            const status = document.getElementById('caseStatus');
            const sView = document.getElementById('singleView');
            const mView = document.getElementById('multiView');

            if (times === 1) {
                mView.style.display = "none";
                sView.style.display = "flex";
                status.innerText = "ƒêang quay...";
                const shuffler = document.getElementById('shuffler');
                shuffler.innerHTML = '';
                shuffler.style.transition = "none";
                shuffler.style.transform = "translateX(0)";

                let finalItem;
                for (let i = 0; i < 40; i++) {
                    const data = getRandItem();
                    if (i === 30) finalItem = data;
                    const div = document.createElement('div');
                    div.className = `case-item ${data.class}`;
                    div.innerHTML = `<span>${data.label}</span>`;
                    shuffler.appendChild(div);
                }

                setTimeout(() => {
                    const itemW = 92; 
                    const targetPos = -(30 * itemW) + (sView.offsetWidth / 2) - (itemW / 2);
                    shuffler.style.transition = "transform 4s cubic-bezier(0.1, 0, 0.1, 1)";
                    shuffler.style.transform = `translateX(${targetPos}px)`;

                    setTimeout(async () => {
                        userData.coins += finalItem.value;
                        status.innerText = `Nh·∫≠n ƒë∆∞·ª£c: ${finalItem.label}`;
                        await saveToSheet();
                        updateUI();
                        document.getElementById('btnSpin1').disabled = false;
                        document.getElementById('btnSpin10').disabled = false;
                    }, 4100);
                }, 50);
            } else {
                sView.style.display = "none";
                mView.style.display = "grid";
                mView.innerHTML = "";
                status.innerText = "ƒêang khui 10 h√≤m...";
                let totalWin = 0;
                for (let i = 0; i < 10; i++) {
                    const data = getRandItem();
                    totalWin += data.value;
                    setTimeout(() => {
                        const div = document.createElement('div');
                        div.className = `case-item ${data.class}`;
                        div.style.minWidth = "auto";
                        div.style.height = "60px";
                        div.innerHTML = `<span style='font-size:10px'>${data.label}</span>`;
                        mView.appendChild(div);
                    }, i * 150);
                }
                setTimeout(async () => {
                    userData.coins += totalWin;
                    status.innerText = `T·ªïng nh·∫≠n: ${totalWin} Xu!`;
                    await saveToSheet();
                    updateUI();
                    document.getElementById('btnSpin1').disabled = false;
                    document.getElementById('btnSpin10').disabled = false;
                }, 1800);
            }
        }

        async function saveToSheet() {
            localStorage.setItem("currentUser", JSON.stringify(userData));
            await fetch(p1, {
                method: "PUT",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ 
                    condition: {username: userData.username}, 
                    set: { 
                        coins: userData.coins, 
                        total_spins: userData.total_spins // L∆∞u l∆∞·ª£t quay v√†o Sheet
                    } 
                })
            });
        }

        // --- H√ÄM M·ªû QU√Ä ---
        async function openLuckyBox() {
            let count = parseInt(userData.lixi_count) || 0;
            if (count <= 0) { alert("H·∫øt l∆∞·ª£t r·ªìi!"); return; }
            const btn = document.getElementById('btnLixi');
            btn.disabled = true;
            try {
                let randomXu = Math.floor(Math.random() * 81) + 20; 
                if (confirm(`S·ª≠ d·ª•ng 1 l∆∞·ª£t ƒë·ªÉ m·ªü qu√†?`)) {
                    const newEntry = `‚úîÔ∏è <b>${userData.username}</b> nh·∫≠n ${randomXu} Xu`;
                    let updatedLogs = (globalData[0].lixi_log || "") + "|" + newEntry;
                    
                    // C·∫≠p nh·∫≠t log v√† tr·ª´ ti·ªÅn Admin ƒë·ªìng th·ªùi
                    await fetch(p1, { method: "PUT", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ condition: {username: "config_row"}, set: { lixi_log: updatedLogs } })});
                    
                    userData.coins = (parseInt(userData.coins) || 0) + randomXu;
                    userData.lixi_count = count - 1;
                    
                    await fetch(p1, { method: "PUT", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ condition: {username: userData.username}, set: { coins: userData.coins, lixi_count: userData.lixi_count } })});
                    
                    alert(`Npc xin tr·∫£ l·ªùi: Nh·∫≠n ${randomXu} Xu!`);
                    localStorage.setItem("currentUser", JSON.stringify(userData));
                    init();
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); }
            btn.disabled = false;
        }

        function loadLogs() {
            const historyEl = document.getElementById('historyList');
            if(globalData[0] && globalData[0].lixi_log) {
                const logs = globalData[0].lixi_log.split("|").filter(x => x !== "");
                historyEl.innerHTML = logs.reverse().map(log => `<li>${log}</li>`).join('');
            }
        }

        function switchRank(type) {
            const list = document.getElementById('leaderboardList');
            document.getElementById('tabXu').className = type === 'xu' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tabLixi').className = type === 'lixi' ? 'tab-btn active' : 'tab-btn';
            let sorted = [...globalData].sort((a, b) => (parseInt(b[type === 'xu' ? 'coins' : 'lixi_count']) || 0) - (parseInt(a[type === 'xu' ? 'coins' : 'lixi_count']) || 0));
            list.innerHTML = sorted.slice(0, 10).map((u, i) => `<li><span>${i+1}. ${u.username}</span> <b>${u[type === 'xu' ? 'coins' : 'lixi_count'] || 0}</b></li>`).join('');
        }

        async function useGiftcode() {
            let code = prompt("Nh·∫≠p m√£:");
            if(!code) return;
            if(["TANTHU", "LIXI888"].includes(code.toUpperCase())) {
                userData.lixi_count = (parseInt(userData.lixi_count) || 0) + 5;
                await fetch(p1, { method: "PUT", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ condition: {username: userData.username}, set: { lixi_count: userData.lixi_count } })});
                alert("Npc xin tr·∫£ l·ªùi: Nh·∫≠n 5 l∆∞·ª£t!");
                updateUI();
            } else { alert("M√£ sai!"); }
        }

        init();
    </script>
</body>
</html>
