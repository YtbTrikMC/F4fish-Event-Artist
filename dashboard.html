<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Artists</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .level-container { width: 100%; background: #ddd; border-radius: 10px; margin: 10px 0; position: relative; height: 22px; overflow: hidden; }
        .level-bar { height: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); width: 0%; transition: 0.5s; }
        .level-text { position: absolute; width: 100%; text-align: center; font-size: 12px; line-height: 22px; font-weight: bold; color: #000; z-index: 1; }
        
        .lucky-box-section { 
            margin-top: 20px; padding: 15px; 
            background: linear-gradient(145deg, #ff4757, #e84118); 
            border: 3px solid #fbc531; border-radius: 15px; 
            color: white; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .lucky-btn { 
            background: #fbc531; color: #c23616; font-weight: bold; 
            border: none; padding: 12px 30px; border-radius: 25px; 
            cursor: pointer; font-size: 16px; text-transform: uppercase;
            box-shadow: 0 4px 0 #e1b12c; transition: 0.2s;
        }
        .lucky-btn:active { transform: translateY(4px); box-shadow: none; }

        /* Style cho BXH k√©p */
        .rank-tabs { display: flex; gap: 5px; margin-top: 20px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: #ecf0f1; cursor: pointer; border-radius: 5px 5px 0 0; font-weight: bold; }
        .tab-btn.active { background: #3498db; color: white; }
        .rank-list { list-style: none; padding: 10px; background: #fff; border: 1px solid #ddd; border-top: none; margin: 0; border-radius: 0 0 5px 5px; }
        .rank-list li { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 14px; }
        .rank-list b { color: #e67e22; }
    </style>
</head>
<body>
    <marquee id="marqueeTxt" class="marquee-style">ƒêang t·∫£i th√¥ng b√°o...</marquee>
    
    <div class="header-bar">
        <div class="balance">Xu: <span id="userCoins">0</span> ü™ô | Level: <span id="userLevel">1</span></div>
        <button class="gift-btn" onclick="useGiftcode()">GIFTCODE</button>
    </div>

    <div class="main-content">
        <div class="level-container">
            <div class="level-text" id="levelScoreTxt">0/100 XP</div>
            <div class="level-bar" id="levelBar"></div>
        </div>

        <div class="fish-section">
            <img src="" id="fishGif" class="fish-gif" onclick="feedFish()" alt="C√°">
            <button id="btnFeed" class="feed-btn" onclick="feedFish()">CHO C√Å ƒÇN (MI·ªÑN PH√ç 24H)</button>
        </div>

        <div class="lucky-box-section">
            <h2 style="margin: 0 0 5px 0;">üßß BAO QU√Ä MAY M·∫ÆN</h2>
            <p style="font-size: 13px; margin-bottom: 10px;">Qu·ªπ qu√† t·∫∑ng c√≤n: <span id="poolCoins" style="font-weight: bold; color: #fbc531;">0</span> Xu</p>
            <button id="btnLixi" class="lucky-btn" onclick="openLuckyBox()">M·ªû QU√Ä NGAY</button>
            <p id="lixiStatus" style="font-size: 11px; margin-top: 10px; opacity: 0.9; font-weight: bold;"></p>
        </div>

        <h3 style="margin-bottom: 10px; margin-top: 25px;">üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
        <div class="rank-tabs">
            <button id="tabXu" class="tab-btn active" onclick="switchRank('xu')">TOP XU</button>
            <button id="tabLixi" class="tab-btn" onclick="switchRank('lixi')">TOP L∆Ø·ª¢T QU√Ä</button>
        </div>
        <ul id="leaderboardList" class="rank-list"></ul>
    </div>

    <script>
        const p1 = "h" + "tt" + "ps://";
        const p2 = "api" + "." + "steinhq" + ".com";
        const p3 = "/v1/storages/";
        const p4 = "699" + "eda16" + "affba40a" + "6254160c"; 
        const FULL_URL = p1 + p2 + p3 + p4 + "/Sheet1";

        let userData = JSON.parse(localStorage.getItem("currentUser"));
        let globalData = [];

        async function init() {
            if (!userData) { window.location.href = "index.html"; return; }
            try {
                const res = await fetch(FULL_URL);
                globalData = await res.json();
                
                const adminAccount = globalData.find(u => u.username === "admin");
                const freshData = globalData.find(u => u.username === userData.username);
                if(freshData) { 
                    userData = freshData; 
                    localStorage.setItem("currentUser", JSON.stringify(freshData)); 
                }

                document.getElementById('userCoins').innerText = userData.coins;
                document.getElementById('poolCoins').innerText = adminAccount ? adminAccount.coins : "0";

                const count = parseInt(userData.lixi_count) || 0;
                document.getElementById('lixiStatus').innerText = count > 0 ? `B·∫°n c√≤n ${count} l∆∞·ª£t m·ªü qu√†!` : "B·∫°n ƒë√£ h·∫øt l∆∞·ª£t m·ªü qu√†.";

                // Hi·ªÉn th·ªã thanh XP v√† Fish Gif (gi·ªØ logic c≈© c·ªßa b·∫°n)
                const score = parseInt(userData.level_score) || 0;
                document.getElementById('levelBar').style.width = (score % 100) + "%";
                document.getElementById('levelScoreTxt').innerText = (score % 100) + "/100 XP";

                switchRank('xu');
            } catch (e) { console.error(e); }
        }

        function switchRank(type) {
            const list = document.getElementById('leaderboardList');
            const btnXu = document.getElementById('tabXu');
            const btnLixi = document.getElementById('tabLixi');
            
            let sorted = [];
            if (type === 'xu') {
                btnXu.classList.add('active');
                btnLixi.classList.remove('active');
                sorted = [...globalData].sort((a, b) => (parseInt(b.coins) || 0) - (parseInt(a.coins) || 0));
                list.innerHTML = sorted.slice(0, 10).map((u, i) => `<li><span>${i+1}. ${u.username}</span> <b>${u.coins} Xu</b></li>`).join('');
            } else {
                btnLixi.classList.add('active');
                btnXu.classList.remove('active');
                sorted = [...globalData].sort((a, b) => (parseInt(b.lixi_count) || 0) - (parseInt(a.lixi_count) || 0));
                list.innerHTML = sorted.slice(0, 10).map((u, i) => `<li><span>${i+1}. ${u.username}</span> <b>${u.lixi_count || 0} L∆∞·ª£t</b></li>`).join('');
            }
        }

        async function openLuckyBox() {
            let count = parseInt(userData.lixi_count) || 0;
            if (count <= 0) { alert("Npc xin tr·∫£ l·ªùi: B·∫°n kh√¥ng c√≤n l∆∞·ª£t!"); return; }

            try {
                const res = await fetch(FULL_URL);
                const allData = await res.json();
                const adminAcc = allData.find(u => u.username === "admin");
                let pool = parseInt(adminAcc.coins) || 0;

                if (pool <= 0) { alert("Npc xin tr·∫£ l·ªùi: Qu·ªπ qu√† ƒë√£ h·∫øt s·∫°ch!"); return; }

                // THU·∫¨T TO√ÅN T·ªà L·ªÜ: T·ªêI THI·ªÇU 20 XU (2.000ƒë)
                let randomXu;
                let rate = Math.random() * 100;
                if (rate < 80) randomXu = Math.floor(Math.random() * (100 - 20 + 1)) + 20;
                else if (rate < 95) randomXu = Math.floor(Math.random() * (500 - 101 + 1)) + 101;
                else if (rate < 99.5) randomXu = Math.floor(Math.random() * (900 - 501 + 1)) + 501;
                else randomXu = Math.floor(Math.random() * (1000 - 901 + 1)) + 901;

                if (randomXu > pool) randomXu = pool;

                if (confirm(`B·∫°n mu·ªën d√πng 1 l∆∞·ª£t ƒë·ªÉ m·ªü qu√†?`)) {
                    // Tr·ª´ qu·ªπ Admin
                    await fetch(FULL_URL, { method: "PUT", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ condition: {username: "admin"}, set: { coins: pool - randomXu } })});
                    // C·ªông xu user v√† tr·ª´ 1 l∆∞·ª£t lixi_count
                    await fetch(FULL_URL, { method: "PUT", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ condition: {username: userData.username}, set: { coins: (parseInt(userData.coins) || 0) + randomXu, lixi_count: count - 1 } })});
                    
                    alert(`Npc xin tr·∫£ l·ªùi: B·∫°n nh·∫≠n ƒë∆∞·ª£c ${randomXu} Xu (~${randomXu * 100}ƒë)!`);
                    location.reload();
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); }
        }

        // C√°c h√†m updateData, feedFish, buyFish... c·ªßa b·∫°n gi·ªØ nguy√™n logic c·∫≠p nh·∫≠t userData
        init();
    </script>
</body>
</html>
