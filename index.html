<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng nhập - Hệ thống Npc</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h2>Npc xin trả lời: Đăng nhập</h2>
        <div class="input-group">
            <input type="text" id="username" placeholder="Tài khoản do Admin cấp">
            <input type="password" id="password" placeholder="Mật khẩu">
        </div>
        <button id="loginBtn" onclick="login()">Vào hệ thống</button>
        <p id="statusMsg" style="font-size: 12px; color: #666; margin-top: 10px;"></p>
    </div>

    <script>
        // Phân chia API để bảo mật
        const p1 = "h" + "tt" + "ps://";
        const p2 = "api" + "." + "steinhq" + ".com";
        const p3 = "/v1/storages/";
        const p4 = "699" + "ed5d6" + "affba40a" + "625413ac";
        const FULL_URL = p1 + p2 + p3 + p4 + "/Sheet1";

        window.onload = function() {
            const entryLock = sessionStorage.getItem('entry_lock');
            if (entryLock && Date.now() < entryLock) {
                document.body.innerHTML = "<div class='container'><h3>Vui lòng chờ 1 phút để đăng nhập lại (chống spam out web)</h3></div>";
            }
        };

        async function login() {
            const userInp = document.getElementById('username').value;
            const passInp = document.getElementById('password').value;
            const btn = document.getElementById('loginBtn');

            // Kiểm tra khóa 10 phút
            const loginLock = localStorage.getItem('login_lock');
            if (loginLock && Date.now() < loginLock) {
                const remain = Math.ceil((loginLock - Date.now()) / 60000);
                alert(`Bạn đang bị khóa. Hãy quay lại sau ${remain} phút.`);
                return;
            }

            if (!userInp || !passInp) { alert("Vui lòng nhập đủ thông tin!"); return; }

            alert("ĐỪNG SPAM NÚT ĐĂNG NHẬP, HÃY CHỜ NÓ LOADING");
            btn.disabled = true;
            btn.innerText = "Đang kiểm tra...";

            try {
                const response = await fetch(`${FULL_URL}?search={"username":"${userInp}"}`);
                const data = await response.json();

                if (data.length > 0 && data[0].password === passInp) {
                    localStorage.setItem("currentUser", JSON.stringify(data[0]));
                    localStorage.removeItem('fail_count');
                    window.location.href = "dashboard.html";
                } else {
                    let fails = (parseInt(localStorage.getItem('fail_count')) || 0) + 1;
                    localStorage.setItem('fail_count', fails);
                    sessionStorage.setItem('entry_lock', Date.now() + 60000); // Khóa 1 phút khi out/vào lại

                    if (fails >= 3) {
                        localStorage.setItem('login_lock', Date.now() + 600000); // Khóa 10 phút
                        alert("Sai 3 lần! Bạn bị khóa 10 phút.");
                    } else {
                        alert("Sai tài khoản hoặc mật khẩu!");
                    }
                }
            } catch (error) {
                alert("Lỗi kết nối API. Hãy kiểm tra lại quyền Editor của Sheet!");
            } finally {
                btn.disabled = false;
                btn.innerText = "Vào hệ thống";
            }
        }
    </script>
</body>
</html>
